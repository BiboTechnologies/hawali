import{initializeApp}from"https://www.gstatic.com/firebasejs/9.0.2/firebase-app.js";import{getStorage,ref as storageRef,uploadBytes,getDownloadURL}from"https://www.gstatic.com/firebasejs/9.0.2/firebase-storage.js";import{getDatabase,ref,remove,push,get,update,onValue,child,set}from"https://www.gstatic.com/firebasejs/9.0.2/firebase-database.js";import{getAuth,onAuthStateChanged,sendPasswordResetEmail,sendEmailVerification,createUserWithEmailAndPassword,signInWithEmailAndPassword,GoogleAuthProvider,signInWithPopup}from"https://www.gstatic.com/firebasejs/9.0.2/firebase-auth.js";const firebaseConfig={apiKey:"AIzaSyAisBpwnYt14S4NiLbcOiAhdINsqwSYJiI",authDomain:"aleveltv-75194.firebaseapp.com",databaseURL:"https://aleveltv-75194-default-rtdb.firebaseio.com",projectId:"aleveltv-75194",storageBucket:"aleveltv-75194.appspot.com",messagingSenderId:"440342498130",appId:"1:440342498130:web:20e2eb670b1cb2c39cc88b",measurementId:"G-VTR1KGT4CW"};const app=initializeApp(firebaseConfig);const database=getDatabase(app);const auth=getAuth(app);const storage=getStorage(app);const toggle=document.getElementById("toggleForm");const formContainer=document.getElementById("formContainer");const backToSignInBtn=document.getElementById("backToSignIn");toggle.addEventListener("click",e=>{formContainer.classList.toggle("signup-active");e.preventDefault()});backToSignInBtn.addEventListener("click",e=>{formContainer.classList.remove("signup-active");e.preventDefault()});const signInForm=document.getElementById("signInForm");const signInBtn=document.getElementById("signInBtn");const spinner=document.querySelector(".spinner");signInForm.addEventListener("submit",async e=>{e.preventDefault();const recaptchaResponse=grecaptcha.getResponse();if(!recaptchaResponse){alert("Please complete the reCAPTCHA verification.");return}const email=document.getElementById("emailInput").value;const password=document.getElementById("passwordInput").value;try{signInBtn.disabled=true;signInBtn.classList.add("loading-btn");spinner.style.display="block";const userCredential=await signInWithEmailAndPassword(auth,email,password);const user=userCredential.user;if(!user.emailVerified){throw new Error("Email not verified. Please check your inbox for the verification email.")}const userRef=ref(database,"users/"+user.uid);const snapshot=await get(userRef);if(snapshot.exists()){console.log("User data already exists in the database")}else{await set(userRef,{email:user.email,displayName:user.displayName});console.log("User data added to the database")}localStorage.setItem("userDetails",JSON.stringify({uid:user.uid,email:user.email,displayName:user.displayName}));window.location.href="index.html"}catch(error){const errorMessage=document.getElementById("error-message");errorMessage.textContent=error.message}finally{signInBtn.disabled=false;signInBtn.classList.remove("loading-btn");spinner.style.display="none"}});let personalDetailsArray=[];const firstNameInput=document.getElementById("signUpFirstNameInput");const lastNameInput=document.getElementById("signUpLastNameInput");const telephoneInput=document.getElementById("signUpTelephoneInput");const dobInput=document.getElementById("signUpDOBInput");const nextButton=document.getElementById("nextToAccountInfo");nextButton.disabled=true;firstNameInput.addEventListener("input",toggleNextButton);lastNameInput.addEventListener("input",toggleNextButton);telephoneInput.addEventListener("input",toggleNextButton);dobInput.addEventListener("input",toggleNextButton);nextButton.addEventListener("click",storePersonalDetails);function toggleNextButton(){const allFieldsFilled=firstNameInput.value.trim()!==""&&lastNameInput.value.trim()!==""&&telephoneInput.value.trim()!==""&&dobInput.value.trim()!=="";nextButton.disabled=!allFieldsFilled}function storePersonalDetails(){personalDetailsArray=[{title:"First Name",value:firstNameInput.value.trim()},{title:"Last Name",value:lastNameInput.value.trim()},{title:"Telephone",value:telephoneInput.value.trim()},{title:"Date of Birth",value:dobInput.value.trim()}];document.getElementById("personalInfoDiv").style.display="none";document.getElementById("accountInfoDiv").style.display="block"}const signUpFormPersonal=document.getElementById("personalInfoForm");const signUpFormAccount=document.getElementById("accountInfoForm");const signUpBtn=document.getElementById("signUpBtn");const spinner2=document.querySelector(".spinner2");const errorMessage2=document.getElementById("error-message2");let personalFormData={};let accountFormData={};signUpFormPersonal.addEventListener("submit",event=>{event.preventDefault();personalDetailsArray=[{title:"First Name",value:personalFormData.firstName},{title:"Last Name",value:personalFormData.lastName},{title:"Telephone",value:personalFormData.telephone},{title:"Date of Birth",value:personalFormData.dob}];console.log("Personal Details:",personalDetailsArray);document.getElementById("personalInfoDiv").style.display="none";document.getElementById("accountInfoDiv").style.display="block"});signUpFormAccount.addEventListener("submit",async event=>{event.preventDefault();const signUpEmailInput=document.getElementById("signUpEmailInput");const signUpPasswordInput=document.getElementById("signUpPasswordInput");const confirmPasswordInput=document.getElementById("confirmPasswordInput");accountFormData={email:signUpEmailInput.value,password:signUpPasswordInput.value,confirmPassword:confirmPasswordInput.value};if(accountFormData.password!==accountFormData.confirmPassword){errorMessage2.textContent="Passwords do not match.";return}try{signUpBtn.disabled=true;signUpBtn.classList.add("loading-btn");spinner2.style.display="block";const userCredential=await createUserWithEmailAndPassword(auth,accountFormData.email,accountFormData.password);const user=userCredential.user;await sendVerificationEmail(user);const combinedUserData={email:accountFormData.email,firstName:personalDetailsArray.find(detail=>detail.title==="First Name")?.value,lastName:personalDetailsArray.find(detail=>detail.title==="Last Name")?.value,telephone:personalDetailsArray.find(detail=>detail.title==="Telephone")?.value,dob:personalDetailsArray.find(detail=>detail.title==="Date of Birth")?.value};saveUser(user.uid,combinedUserData);displaySuccessMessage();signUpFirstNameInput.value="";signUpLastNameInput.value="";signUpTelephoneInput.value="";signUpDOBInput.value="";signUpEmailInput.value="";signUpPasswordInput.value="";confirmPasswordInput.value="";setTimeout(()=>{location.reload()},2e3)}catch(error){errorMessage2.textContent=error.message}finally{signUpBtn.disabled=false;signUpBtn.classList.remove("loading-btn");spinner2.style.display="none"}});function saveUser(userId,userData){const usersRef=ref(database,"users/"+userId);update(usersRef,userData).then(()=>{console.log("User data saved successfully")})["catch"](error=>{console.error("Error saving user data:",error)})}async function sendVerificationEmail(user){await sendEmailVerification(user);displaySuccessMessage()}function displaySuccessMessage(){const successMessage=document.createElement("div");successMessage.textContent="Verification email sent. Please check your inbox.";successMessage.classList.add("success-message");document.body.appendChild(successMessage);setTimeout(()=>{},100);setTimeout(()=>{document.body.removeChild(successMessage)},5e3)}function displayMessage(){const successMessage=document.createElement("div");successMessage.textContent="Password reset email sent successfully! Check your email.";successMessage.classList.add("success-message");document.body.appendChild(successMessage);setTimeout(()=>{},100);setTimeout(()=>{document.body.removeChild(successMessage)},5e3)}function startResendCountdown(){const countdownElement=document.getElementById("countdown");const resendCountdownElement=document.getElementById("resendCountdown");const resendButton=document.getElementById("sendResetEmailBtn");let timeInSeconds=120;const countdownInterval=setInterval(function(){const minutes=Math.floor(timeInSeconds/60);const seconds=timeInSeconds%60;countdownElement.textContent=`${minutes}:${seconds<10?"0":""}${seconds}`;if(timeInSeconds<=0){clearInterval(countdownInterval);countdownElement.textContent="0:00";resendCountdownElement.style.display="none";resendButton.style.cursor="pointer";resendButton.disabled=false;resendButton.classList.remove("dull-btn")}else{resendButton.style.cursor="not-allowed";resendButton.disabled=true;resendButton.classList.add("dull-btn")}timeInSeconds--},1e3)}document.getElementById("forgotPasswordLink").addEventListener("click",function(){document.getElementById("signInForm").style.display="none";document.getElementById("passwordResetForm").style.display="block"});document.getElementById("backToSignInLink").addEventListener("click",function(){document.getElementById("signInForm").style.display="block";document.getElementById("passwordResetForm").style.display="none"});document.getElementById("sendResetEmailBtn").addEventListener("click",async function(){const resetEmail=document.getElementById("resetEmailInput").value;const button=document.getElementById("sendResetEmailBtn");const spinner=button.querySelector(".spinner");const btnText=document.getElementById("btnText");button.disabled=true;button.classList.add("dull-btn");spinner.style.display="inline-block";btnText.style.display="inline-block";try{await sendPasswordResetEmail(auth,resetEmail);displayMessage();document.getElementById("resendCountdown").style.display="block";startResendCountdown()}catch(error){console.error(error.message)}finally{spinner.style.display="none";button.disabled=false;button.classList.remove("dull-btn")}});